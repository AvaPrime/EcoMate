# EcoMate – Repo Audit, Governance & Publishing Playbook

A single set of **directives and examples** you can hand to the AI coding assistant to:
1) Install and run repo **audit tools** with clear outputs.
2) Update **licensing** to proprietary.
3) Configure **GitHub settings** (About, protections, Pages).
4) Publish **Docsites** (MkDocs/GitHub Pages), and make **AI Services API / Temporal Web UI / MinIO Console** live.
5) Cut the **first release** and verify everything end‑to‑end.

> **Conventions**: Commands assume the repo name `AvaPrime/EcoMate` and default branch `main`. Replace placeholders `YOUR_ORG`, `YOUR_DOMAIN`, etc.

---

## 0) Prereqs
- Install GitHub CLI: `gh auth login`
- Ensure Python 3.10+, Node 18+, Docker
- Grant repo write: actions, packages, pages

---

## 1) Repo Audit Tools — Install, Run, Report

### 1.1 Create the audit tool
**File:** `tools/audit_repo.py`
```python
#!/usr/bin/env python3
import os, re, json
from pathlib import Path
ROOT = Path(__file__).resolve().parents[1]
EXPECT_FILES = [
  'services/proposal/bom_engine.py', 'services/proposal/cost_model.py',
  'services/catalog/sync.py', 'services/maintenance/scheduler.py',
  'services/compliance/engine.py', 'services/compliance/rules/',
  'services/telemetry/ingestor.py', 'services/api/main.py',
  '.github/workflows/'
]
STUB_PATTERNS = [r"\\bTODO\\b", r"\\bFIXME\\b", r"raise NotImplementedError", r"#\\s*stub", r"pass\\s*(#.*)?$"]
CI_EXPECT = ['.github/workflows/pr-polish.yml', '.github/workflows/compliance-gate.yml']
DOCS_EXPECT = [
  'eco_mate_master_index_roadmap_overview.md',
  'eco_mate_future_roadmap_living_document.md',
  'eco_mate_production_implementation_plan_drop_in_files_steps.md',
  'eco_mate_market_supply_chain_data_integration.md',
  'eco_mate_regulatory_compliance_data_integration.md',
  'eco_mate_environmental_geographic_data_integration_implementation_plan.md',
  'eco_mate_operational_predictive_data_integration.md'
]

def file_exists(p: Path):
    return (ROOT/p).exists() if str(p).endswith('/') else (ROOT/p).is_file()

def scan_stubs(p: Path):
    try: txt = p.read_text(encoding='utf-8', errors='ignore')
    except: return []
    hits = []
    for pat in STUB_PATTERNS:
        for m in re.finditer(pat, txt, re.M|re.I):
            line = txt.count('\n', 0, m.start()) + 1
            hits.append({'pattern': pat, 'line': line})
    return hits

def walk_py(root): return [p for p in (ROOT/root).rglob('*.py')]

def main():
    status = {"missing_files":[], "present_files":[], "stub_findings":{},
              "ci_present":[], "ci_missing":[], "docs_present":[], "docs_missing":[]}
    for f in EXPECT_FILES:
        (status['present_files'] if file_exists(Path(f)) else status['missing_files']).append(f)
    for py in walk_py('services'):
        hits = scan_stubs(py)
        if hits: status['stub_findings'][str(py)] = hits
    for ci in CI_EXPECT:
        (status['ci_present'] if file_exists(Path(ci)) else status['ci_missing']).append(ci)
    for d in DOCS_EXPECT:
        (status['docs_present'] if file_exists(Path(d)) else status['docs_missing']).append(d)
    print(json.dumps(status, indent=2))

if __name__ == '__main__': main()
```

### 1.2 Reporting script
**File:** `tools/audit_report.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail
python3 tools/audit_repo.py | tee audit.json
python3 - "$@" <<'PY'
import json, pathlib
j=json.load(open('audit.json'))
missing='\n'.join(f"- {x}" for x in j['missing_files']) or '- None'
ci_m='\n'.join(f"- {x}" for x in j['ci_missing']) or '- None'
d_m='\n'.join(f"- {x}" for x in j['docs_missing']) or '- None'
stubs=[]
for f, hits in j['stub_findings'].items():
    stubs.append('### '+f+'\n'+'\n'.join(f"- line {h['line']}: {h['pattern']}" for h in hits))
stubs='\n\n'.join(stubs) or '_No stub patterns found._'
md=f"""# EcoMate Repo Audit — Snapshot\n\n## Missing Expected Files\n{missing}\n\n## Stub/Placeholder Findings\n{stubs}\n\n## CI Workflows Missing\n{ci_m}\n\n## Roadmap Docs Missing\n{d_m}\n\n_Generated by tools/audit_repo.py_\n"""
pathlib.Path('AUDIT_REPORT.md').write_text(md)
print('Wrote AUDIT_REPORT.md')
PY
```

### 1.3 CI: run audit on push + weekly, auto‑PR the report
**File:** `.github/workflows/audit.yml`
```yaml
name: Repo Audit
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '23 4 * * 1'
jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install -U pip
      - run: bash tools/audit_report.sh
      - name: Commit report
        run: |
          if [ -n "$(git status --porcelain AUDIT_REPORT.md audit.json)" ]; then
            git config user.name "eco-bot"; git config user.email "bot@users.noreply.github.com"
            git add AUDIT_REPORT.md audit.json
            git commit -m "chore(audit): update report"
          fi
      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore(audit): weekly repo audit report"
          branch: chore/audit-report
          commit-message: "chore(audit): update report"
          body: "Automated audit report update."
```

**Outputs:**
- `audit.json` (machine‑readable)
- `AUDIT_REPORT.md` (human‑readable)
- Auto PR titled **chore(audit): weekly repo audit report**

---

## 2) Licensing — Make it Proprietary

### 2.1 Replace MIT with Proprietary LICENSE
**Action:** Delete existing `LICENSE` and add `LICENSE.md`:

**File:** `LICENSE.md`
```md
# EcoMate Proprietary License

Copyright (c) 2025 AvaPrime. All rights reserved.

This software and its source code (the “Software”) are proprietary to AvaPrime.
Unauthorized copying, modification, distribution, or use is prohibited except as
expressly permitted by a written agreement with AvaPrime.

You may not:
- Copy, modify, merge, publish, distribute, sublicense, or sell copies of the Software;
- Reverse engineer, decompile, or disassemble the Software; or
- Remove or alter any proprietary notices.

No rights are granted by implication, estoppel, or otherwise. The Software is provided
“AS IS,” without warranty of any kind.
```

### 2.2 Dual‑license docs (optional)
If you want docs to remain open:

**File:** `docs/LICENSE-docs.md`
```md
Documentation © 2025 AvaPrime. Licensed under the MIT License for documentation only.
```

### 2.3 Notice headers
Add a short header to key source files (optional):
```python
# Copyright (c) 2025 AvaPrime. All rights reserved.
# Use of this source code is governed by a proprietary license that can be
# found in the LICENSE.md file.
```

### 2.4 Repo visibility
- **Recommended:** Set repo to **Private** if proprietary.
- If staying public, the code is still visible; license restricts use but not viewing.

---

## 3) GitHub Repo Settings (About, Protections, Pages)

### 3.1 About section (gh CLI)
```bash
# Description & homepage
gh repo edit AvaPrime/EcoMate \
  --description "EcoMate: Proposal, compliance, telemetry & digital-twin platform" \
  --homepage "https://avaprime.github.io/EcoMate/"

# Topics
gh repo edit AvaPrime/EcoMate \
  --add-topic sustainability --add-topic telemetry --add-topic water-treatment \
  --add-topic digital-twin --add-topic compliance --add-topic ai
```

### 3.2 Branch protection (require status checks)
```bash
gh api -X PUT repos/AvaPrime/EcoMate/branches/main/protection \
  -f required_status_checks.strict=true \
  -f enforce_admins=true \
  -f required_pull_request_reviews.required_approving_review_count=1 \
  -f restrictions=null \
  -H "Accept: application/vnd.github+json"
```
Include required checks: `Repo Audit`, `Compliance Gate`, `Tests`.

### 3.3 Pages (mkdocs output)
- Settings → Pages → Build from GitHub Actions (recommended) or `gh-pages` branch.

---

## 4) Docsites — MkDocs → GitHub Pages

### 4.1 MkDocs skeleton
**Files:**
- `mkdocs.yml` (site config)
- `docs/index.md` (landing that links to Master Index)

**Example `mkdocs.yml`:**
```yaml
site_name: EcoMate Docs
repo_url: https://github.com/AvaPrime/EcoMate
nav:
  - Home: index.md
  - Roadmap: eco_mate_master_index_roadmap_overview.md
  - Implementation: eco_mate_production_implementation_plan_drop_in_files_steps.md
theme:
  name: material
```

### 4.2 CI to publish MkDocs
**File:** `.github/workflows/docs.yml`
```yaml
name: Publish Docs
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install mkdocs mkdocs-material
      - run: mkdocs build --strict
      - uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
```

### 4.3 Verify Pages is live
- Check `https://avaprime.github.io/EcoMate/` responds 200.
- Ensure About → Website points to Pages URL.

> **OpenWiki/GitHub Wiki**: Enable Wiki in repo Settings → then create `Home` page; link from MkDocs nav if desired.

---

## 5) Make Services Live — API, Temporal (Temple) UI, MinIO Console

> GitHub Pages is static hosting. For live services, deploy containers to a runtime (Railway, Fly.io, Render, Azure, AWS). Below shows GHCR + Railway as example.

### 5.1 Containerize & publish images
**File:** `Dockerfile.api` (FastAPI)
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY services services
CMD ["uvicorn", "services.api.main:app", "--host", "0.0.0.0", "--port", "8080"]
```

**File:** `.github/workflows/build-images.yml`
```yaml
name: Build & Push Images
on: [push]
jobs:
  api:
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.api
          push: true
          tags: ghcr.io/avaprime/ecomate-api:latest
```

### 5.2 Deploy to Railway (example)
- Create project, add service from GHCR image `ghcr.io/avaprime/ecomate-api:latest`
- Set env vars; expose port 8080
- Add healthcheck `/docs` (FastAPI OpenAPI UI)

**Optional compose (local dev):** `docker-compose.yml`
```yaml
services:
  api:
    build: { context: ., dockerfile: Dockerfile.api }
    ports: ["8080:8080"]
  temporal-ui:
    image: temporalio/ui:latest
    environment: { TEMPORAL_ADDRESS: temporal:7233 }
    ports: ["8081:8080"]
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: change-me
    ports: ["9000:9000", "9001:9001"]
```

### 5.3 Verification checklist
- API: `GET https://YOUR_API_HOST/health` → 200 (or `/docs` loads)
- Temporal UI: reachable at `https://YOUR_TEMPORAL_UI_HOST`
- MinIO Console: `https://YOUR_MINIO_HOST:9001/` loads; login works

---

## 6) First Release (v0.1.0)

### 6.1 Tag & release via gh
```bash
git tag -a v0.1.0 -m "EcoMate v0.1.0: Phase 1 foundation"
git push origin v0.1.0

gh release create v0.1.0 \
  --title "EcoMate v0.1.0" \
  --notes-file CHANGELOG.md \
  --generate-notes
```

**Tip:** Add artifacts (e.g., sample proposal PDF) with `--assets`.

### 6.2 Packages visibility
- Check **Packages** tab for `ghcr.io/avaprime/ecomate-api:latest`
- Mark as public/private per policy; attach to repo

---

## 7) Governance & Security
- **Branch protections**: required checks (Audit, Docs, Tests, Compliance Gate)
- **CODEOWNERS**: reviewers & approvers
- **SECURITY.md**: vulnerability reporting policy
- **Dependabot**: enable `version-updates` & `security-updates`
- **Secret scanning**: enable push protection

**File:** `.github/CODEOWNERS`
```
* @AvaPrime/core-team
services/** @AvaPrime/platform
```

**File:** `.github/SECURITY.md`
```md
Report security issues to security@avaprime.com. We aim to respond within 72 hours.
```

**File:** `.github/dependabot.yml`
```yaml
version: 2
updates:
  - package-ecosystem: "pip"
    directory: "/"
    schedule: { interval: "weekly" }
```

---

## 8) README updates (link Master Index)
Add this block near the top:
```md
## Roadmap & Blueprints
See the [Master Index & Roadmap Overview](eco_mate_master_index_roadmap_overview.md) for links to the Future Roadmap, Production Plan, and all integration packs.
```

---

## 9) Final Verification Checklist
- [ ] `AUDIT_REPORT.md` present and PR created
- [ ] `LICENSE.md` proprietary and repo visibility correct
- [ ] README shows Roadmap block; About section set (description, topics, website)
- [ ] Pages live at `https://avaprime.github.io/EcoMate/`
- [ ] API deployed (health OK)
- [ ] Temporal (Temple) Web UI reachable
- [ ] MinIO Console reachable
- [ ] Release `v0.1.0` published; packages present in GHCR

---

Hand this playbook to the AI coding assistant and execute top‑down. It will leave you with a governed, auditable, and live EcoMate platform.

